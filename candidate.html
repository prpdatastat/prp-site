<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PRP Statistics</title>
    <script src="https://unpkg.com/sync-fetch"></script> 
    <link rel="stylesheet" href="index.css" />
        
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="data.js"></script>
    <link
      href="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.8/r-3.0.2/sl-2.0.3/datatables.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.8/r-3.0.2/sl-2.0.3/datatables.min.js"></script>
    
  </head>
  <body>
    <nav class="navbar">
      <div class="logo-container">
        <img class="logo"  onclick="homeUrl()" src="logo.png" />
      </div>
    </nav>
    <div class="main_container">
    <div class="info">
        <h1 id="name">
            Ali Tahir
        </h1>
        <div class="cutoff-bubble">
          <span > Applicant ID: <strong id="applicantId"> 15610</strong></span><br>
          <br>        
          <span > PMDC Number: <strong id="pmdcNo"> 15610</strong></span><br>
          

        </div>
        <div class="aggMarks">Provisional Marks:   
          <span class="bubble "id="provMarks">29
            <span class="bubble" id="matricMarks">4
              <span class="bubble" id="interMarks">6
                <span class="bubble" id="degreeMarks">14
                  <span class="bubble" id="houseJobMarks">5
                    <span class="bubble" id="experienceMarks">4</span></span></span></span></span>
          </span>
        </div>
        
        <div class="aggMarks progMarks">FCPS:  
          <span class="bubble FCPSmarks" id="houseJobMarks">5</span> MS:  <span class="bubble MSmarks" id="experienceMarks">0</span> MD:  <span class="bubble MDmarks" id="experienceMarks">0</span>
        </div>
        <div class="legend"> Legend: 
          <span class="legend-bubble" id="matricMarks">matric</span>
          <span class="legend-bubble" id="interMarks">inter</span>
          <span class="legend-bubble" id="degreeMarks">degree</span>
          <span class="legend-bubble" id="houseJobMarks">housejob</span>
          <span class="legend-bubble" id="experienceMarks">experience</span>

        </div>
        <p>
            Below is the list of hospital he / she applied for
        </p>
        
        
    </div>
    <div class="filters">
      <select
        onchange="updateList(event);"
        class="filter-item"
        name="quota"
        id="program"
      >
      <option disabled selected value="">Select a program
      </option>
    </select>
    </div>
    <table class="stat-table" style="width: 100%" id="statTable">
      <thead>
        <tr>
          <th>Quota</th>
          <th>Hospital</th>
          <th>Speciality</th>
          <th>Aggregate</th>
          <th>Preference No.</th>
          <th>Selected</th>
        </tr>
      </thead>
      <tbody id="dataRows"></tbody>
    </table>
    
    
    <div class="footer">
      <span>Made with ðŸ’“ in <strong>HTML</strong>  &  <strong>JS</strong> by <img src="github.png">reko-beep</span>
    </div>
    </div>
    
    <script>   
    let data = {};   
    const default_filter = {
      pmdcNo : '',
      program : 'FCPS'
    };
    const meritData = {
      FCPS: fcpsMerit,
      MS: msMerit,
      MD: mdMerit,
    };
    const  columnParams = ['quotaName', 'hospitalName', 'specialityName'];
    jQuery(document).ready(function () {
      const pmdcNumber = localStorage.getItem('pmdcNo')
      data = getCandidatesData(pmdcNumber);
      default_filter.pmdcNo = pmdcNumber;
      console.log(data);
      const marksagg = document.getElementsByClassName('aggMarks')[0];
      marksagg.innerHTML = `Provisional Marks
      <span class="bubble "id="provMarks">${data.provMarks}
            <span class="bubble" id="matricMarks">${data.matric}
              <span class="bubble" id="interMarks">${data.inter}
                <span class="bubble" id="degreeMarks">${data.degree}
                  <span class="bubble" id="houseJobMarks">${data.houseJob}
                    <span class="bubble" id="experienceMarks">${data.experience}</span></span></span></span>`
      for (pro in data.progMarks) {
        const elet = document.getElementsByClassName(pro+'marks')[0];
        
        console.log(pro, pro+'Marks', elet)
        elet.innerHTML = data.progMarks[pro]

      }
      
      const nameele = document.getElementById('name');
      nameele.innerHTML = data.name;

      
      pmdcNo.innerHTML = data.pmdcNo;
      const applicantele = document.getElementById('applicantId');
      applicantele.innerHTML = data.applicantId;   
      jQuery("#statTable").DataTable({
        paging: true,
        searching: true,
        ordering: true,
        lengthMenu: [10, 25, 50, { label: "All", value: -1 }],
        lengthChange: true,
        columns: [
          { width: "10%" },
          { width: "20%" },
          { width: "10%" },
          { width: "10%" },
          { width: "20%" },
          { width: "5%" },
        ],
      });
      changeProgramMerit()
    });
    
    $('#statTable').on('click', 'tbody td', function() {   
      let param =   columnParams[this._DT_CellIndex.column];
      let paths = {
        specialityName : 'speciality.html',
        hospitalName : 'hospital.html',
        pmdcNo : 'candidate.html'
      }
      const checkParams = ['hospitalName', 'pmdcNo', 'specialityName'];
      if (checkParams.includes(columnParams[this._DT_CellIndex.column]))
      {
      localStorage.setItem(columnParams[this._DT_CellIndex.column], this.textContent)
      window.location.href = paths[param]
      }
    }
)
    function changeProgramMerit() {
      let merit = data[default_filter.program];
      console.log(merit)
      jQuery("#statTable").DataTable().clear().draw();
      for (cand in merit) {
        jQuery("#statTable")
          .DataTable()
          .row.add([
            merit[cand].quotaName,
            
            merit[cand].hospitalName,
            merit[cand].specialityName,
            merit[cand].marks,
            merit[cand].preferenceNo,
            merit[cand].symbol
          ]);
      }
      jQuery("#statTable").DataTable().draw();
      addToolTips()
    }
    console.log(default_filter)
    const filters = document.getElementsByTagName("select");
    console.log(filters)
    for (filter in filters) {      
      console.log(filter.id)
      let options = getOptions(filters[filter].id);
      console.log("options", options);
      for (opt in options) {
        filters[filter].innerHTML +=
          "<option value='" + options[opt] + "'>" + options[opt] + "</option>";
      }
    }
    
    for (key in default_filter) {
      const ele = document.getElementById(key);
      ele.value = default_filter[key];
    }
    function updateList(e) {
      default_filter[e.target.id] = e.target.value;
      changeProgramMerit();
    }
    function getSpecialityLowestMerit(quota, specia, hospi) {
      let meritDataSpeciality = getMerit(
        meritData[default_filter.program],
        quota,
        specia,
        hospi)
      
      meritDataSpeciality.sort( (a,b) => a.marksTotal - b.marksTotal)
      console.log(meritDataSpeciality, meritDataSpeciality[0])
      return "<span class='tooltip-inf'>Lowest merit for "+ specia+ " , "+hospi +" in "+ default_filter.program + " was "+ meritDataSpeciality[0].marksTotal.toString()+"<span>"


      
    }

    $('#statTable').on( 'draw.dt',  function () {
      addToolTips()
  })
  function htmlDecode(input) {
  var doc = new DOMParser().parseFromString(input, "text/html");
  return doc.documentElement.textContent;
}
    function addToolTips() {
  var table = $("#statTable").DataTable();
  var statRows = table.rows().nodes().to$();
  statRows.each(function() {
    $(this).addClass('selectedInfo');
  });

  console.log(statRows);
  console.log(typeof statRows);

  tippy(".selectedInfo", {    
      
    theme: "prp",
    content(reference) {
      const quotaspec = htmlDecode(document.getElementsByTagName('td')[0].innerHTML);
      const hospitalspec = htmlDecode(document.getElementsByTagName('td')[1].innerHTML);
      const specialityspec = htmlDecode(document.getElementsByTagName('td')[2].innerHTML);
      console.log(quotaspec, hospitalspec, specialityspec)
      const tooltip = getSpecialityLowestMerit(quotaspec,specialityspec, hospitalspec);

      return tooltip;
    },
    allowHTML: true,
  });
}
    </script>
    </div>
  </body>
</html>