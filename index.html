<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PRP Statistics</title>
    <script src="https://unpkg.com/sync-fetch"></script>
    <script src="data.js"></script>
    <link
      href="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.8/r-3.0.2/sl-2.0.3/datatables.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.8/r-3.0.2/sl-2.0.3/datatables.min.js"></script>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo-container">
        <img class="logo" onclick="homeUrl()"src="logo.png" />
      </div>
    </nav>

    <div class="main_container" style="width: 80%">
      <div class="flex stat-container">
        <div class="counter">
          <div id="FCPS" class="counter-value">500</div>
          <div class="counter-text">FCPS</div>
          <div class="counter-desc">Number of candidates applied</div>
        </div>
        <div class="counter">
          <div id="MD" class="counter-value">500</div>
          <div class="counter-text">MD</div>
          <div class="counter-desc">Number of candidates applied</div>
        </div>
        <div class="counter">
          <div id="MS" class="counter-value">500</div>
          <div class="counter-text">MS</div>
          <div class="counter-desc">Number of candidates applied</div>
        </div>
      </div>
      <div class="filters">
        <select
          onchange="updateList(event);"
          class="filter-item"
          name="quota"
          id="program"
        >
          <option value="" disabled selected>Program</option>
        </select>
        <select
          onchange="updateList(event);"
          class="filter-item"
          name="speciality"
          id="quota"
        >
          <option value="" selected>Quota</option>
        </select>
        <select
          onchange="updateList(event);"
          class="filter-item"
          name="quota"
          id="speciality"
        >
          <option value="" selected>Speciality</option>
        </select>
        <select
          onchange="updateList(event);"
          class="filter-item"
          name="quota"
          id="hospital"
        >
          <option value="" elected>Hospital</option>
        </select>
      </div>
      <table class="stat-table" style="width: 100%" id="statTable">
        <thead>
          <tr>
            <th>PMDC Number</th>
            <th>Name</th>
            <th>Quota</th>
            <th>Speciality</th>
            <th>Hospital</th>
            <th>Aggregate</th>
            <th>Preference No.</th>
          </tr>
        </thead>
        <tbody id="dataRows"></tbody>
      </table>
    </div>
  </body>
  <script>
    const default_filter = {
      program: "FCPS",
      quota: "",
      speciality: "",
      hospital: "",
    };
    const meritData = {
      FCPS: fcpsMerit,
      MS: msMerit,
      MD: mdMerit,
    };
    const columnParams = ['pmdcNo', 'name', 'quotaName', 'specialityName', 'hospitalName']
    changeMeritList()
    jQuery(document).ready(function () {
      jQuery("#statTable").DataTable({
        paging: true,
        searching: true,
        ordering: true,
        lengthMenu: [10, 25, 50, { label: "All", value: -1 }],
        lengthChange: true,
        columns: [
          { width: "10%" },
          { width: "20%" },
          { width: "10%" },
          { width: "10%" },
          { width: "20%" },
          { width: "5%" },
          { width: "5%" },
        ],
      });
      changeMeritList();
    });
    function changeMeritList() {
      let merit = getMerit(
        meritData[default_filter.program],
        default_filter.quota,
        default_filter.speciality,
        default_filter.hospital
      );
      jQuery("#statTable").DataTable().clear().draw();
      for (cand in merit) {
        jQuery("#statTable")
          .DataTable()
          .row.add([
            merit[cand].pmdcNo,
            merit[cand].nameFull,
            merit[cand].quotaName,
            merit[cand].specialityName,
            merit[cand].hospitalName,
            merit[cand].marksTotal,
            merit[cand].preferenceNo,
          ]);
      }
      jQuery("#statTable").DataTable().draw();
    }

    $('#statTable').on('click', 'tbody td', function() {   
      let param =   columnParams[this._DT_CellIndex.column];
      let paths = {
        specialityName : 'speciality.html',
        hospitalName : 'hospital.html',
        pmdcNo : 'candidate.html'
      }
      localStorage.setItem(columnParams[this._DT_CellIndex.column], this.textContent)
      window.location.href = paths[param]
    }
)


    function animateValue(obj, start, end, duration) {
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
          window.requestAnimationFrame(step);
        }
      };
      window.requestAnimationFrame(step);
    }

    const filters = document.getElementsByTagName("select");
    console.log(filters);
    for (filter in filters) {
      let options = getOptions(filters[filter].id);
      for (opt in options) {
        filters[filter].innerHTML +=
          "<option value='" + options[opt] + "'>" + options[opt] + "</option>";
      }
    }
    for (key in default_filter) {
      console.log("key", key);
      const ele = document.getElementById(key);
      ele.value = default_filter[key];
    }
    function updateList(e) {
      default_filter[e.target.id] = e.target.value;
      console.log(default_filter);
      changeMeritList();
    }
    const candidatesData = getCandidatesNumber();
    console.log(candidatesData);
    for (program in candidatesData) {
      const ele = document.getElementById(program);
      console.log(ele);
      animateValue(ele, 0, candidatesData[program], 2500);
    }
  </script>
</html>
